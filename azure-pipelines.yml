trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  TF_VERSION: '1.6.0'
  TF_BACKEND_STORAGE_ACCOUNT: '<your-storage-account>'
  TF_BACKEND_CONTAINER: 'tfstate'
  TF_BACKEND_KEY: 'revision1.tfstate'
  AZURE_SERVICE_CONNECTION: '<your-service-connection-name>'

steps:
- checkout: self

# Install Terraform
- task: AzureCLI@2
  displayName: "Install Terraform"
  inputs:
    azureSubscription: $(AZURE_SERVICE_CONNECTION)
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -e
      echo "Installing Terraform v${TF_VERSION}"
      wget https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip -q
      unzip -o terraform_${TF_VERSION}_linux_amd64.zip
      sudo mv terraform /usr/local/bin/
      terraform --version

# Terraform Init
- script: |
    set -e
    cd infra
    terraform init \
      -backend-config="storage_account_name=$(TF_BACKEND_STORAGE_ACCOUNT)" \
      -backend-config="container_name=$(TF_BACKEND_CONTAINER)" \
      -backend-config="key=$(TF_BACKEND_KEY)"
  displayName: "Terraform Init"

# Terraform Validate
- script: |
    set -e
    cd infra
    terraform validate
  displayName: "Terraform Validate"

# Terraform Plan
- script: |
    set -e
    cd infra
    terraform plan -out=tfplan
  displayName: "Terraform Plan"

# Terraform Apply (Auto Approve)
- script: |
    set -e
    cd infra
    terraform apply -auto-approve tfplan
  displayName: "Terraform Apply"
